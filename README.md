# WagonCount 项目文档

## 一、项目概述

WagonCount 是一个专注于列车车厢计数的计算机视觉项目，旨在通过图像与视频分析技术，自动实现对列车车厢数量的精准统计。该项目适用于铁路运输调度、货运量统计、轨道安全监控等场景，能够替代人工计数，提升工作效率与统计准确性，为相关业务场景提供自动化、智能化的计数解决方案。

## 二、核心工作内容

### （一）项目架构设计与模块划分

按照功能职责将项目拆解为多个独立模块，确保代码结构清晰、可维护性强，各模块分工明确且协同工作：

1. **config 模块**：负责项目配置参数的管理，包含模型参数、视频/图像输入输出路径、计数规则阈值等配置项，支持灵活调整参数以适配不同场景。
2. **examples 模块**：提供项目使用示例，包含测试用图像/视频文件、示例代码脚本，方便用户快速上手了解项目的使用流程与效果。
3. **models 模块**：核心算法模型存放目录，集成了目标检测、目标跟踪相关的预训练模型或自定义模型，是实现车厢识别与计数的核心组件。
4. **tracker 模块**：实现目标跟踪功能，针对视频流中的列车车厢，在检测到目标后持续跟踪其运动轨迹，避免重复计数或漏计数，确保计数连续性与准确性。
5. **ultralytics 模块**：集成 Ultralytics 相关工具与依赖（推测基于 YOLOv8模型），为目标检测提供高效的算法支持，提升车厢识别的速度与精度。
6. **video_examples 模块**：存放项目测试用视频素材，涵盖不同场景（如晴天、阴天、不同光照、不同列车类型）下的视频数据，用于验证项目在多样环境中的适应性。

### （二）核心模块说明

1. #### **tracker/object_counter.py:**

   主要功能是 **统计视频中不同车厢目标的数量**，核心特点是：

   1. **通过唯一跟踪 ID 去重**

      - 对视频中同一个目标（例如同一节车厢）多帧出现的情况，只算一次，避免重复计数。

   2. **保留最高置信度的类别信息**

      - 如果同一个目标在不同帧中被分类为不同类别，函数会选择置信度最高的一次作为最终类别。

   3. **灵活配置跟踪参数**

      - 可以通过配置文件或者额外参数（kwargs）调整跟踪模型行为，比如是否开启调试打印、跟踪阈值等。

   4. **输出直观统计结果**

      - 最终返回一个 `Counter` 对象，包含每类目标的数量，例如：

        ```python
        Counter({'locomotive': 3, 'hopper': 7, 'tank': 29})
        ```

      - 可以直接用于数据分析或报告生成。

2. #### **tracker/train_detector.py:**

   主要功能是 **检测视频中是否存在移动的火车**。大体功能可以概括如下：

   ------

   1. ##### **功能目标**

   - 输入视频，判断其中是否有火车出现并在移动。
   - 输出布尔值：
     - `True`：检测到移动火车。
     - `False`：未检测到火车。

   ------

   2. ##### **核心思路**

   3. **加载模型和配置**

      - 通过 `load_config` 和 `load_param` 获取火车检测器的参数，包括置信度阈值、方向变化阈值等。
      - 支持通过额外参数覆盖默认配置。

   4. **记录目标轨迹**

      - 使用一个字典 `trajectories` 存储每个目标的移动信息：
        - 连续帧数
        - 上一帧的中心点
        - 上一帧的移动方向向量

   5. **逐帧分析目标移动**

      - 遍历模型跟踪输出，每帧提取目标的 ID 和中心点。
      - 对每个 ID：
        - 计算当前位置与上一帧的中心点向量。
        - 判断移动幅度是否足够（几乎静止的目标会忽略）。
        - 如果方向变化过大，则认为轨迹断开，重新计数。
        - 累计连续移动帧数。

   6. **判定火车出现**

      - 当某个目标的连续移动帧数超过预设阈值 `tolerance` 且方向变化在允许范围内 `max_angle`：
        - 判定检测到火车。
        - 可触发模型预测（`model.predict()`）。
        - 返回 `True`。

   7. **未检测到火车**

      - 如果遍历完整个视频没有满足条件的轨迹，则返回 `False`。

   ------

   ##### 3. **特点**

   - **基于轨迹判断**：不仅依赖单帧检测，还结合目标的连续运动情况。
   - **方向变化限制**：避免误把突然改变方向的目标判定为火车。
   - **阈值可调**：通过 `tolerance` 和 `max_angle` 控制判定的敏感度。
   - **调试友好**：`debug` 模式下会打印检测状态。

## 三、开发环境

### （一）核心依赖库

项目依赖的关键第三方库均已整理至 `requirements.txt` 文件中，核心依赖包括（推测，具体以文件内容为准）：

1. 计算机视觉库：OpenCV（用于图像/视频读取、预处理）。
2. 深度学习框架：PyTorch（用于模型加载与推理）。
3. 目标检测工具：Ultralytics（YOLO 系列模型支持）。
4. 其他辅助库：NumPy（数值计算）、Pillow（图像处理）等。

### （二）运行环境

1. 操作系统：Windows（支持 `run.bat` 脚本直接运行），可适配 Linux/macOS（需手动配置运行命令）。
2. 硬件要求：建议配备独立显卡（NVIDIA GPU），支持 CUDA 加速，提升模型推理与视频处理速度；无 GPU 环境下可运行，但处理大型视频时速度可能受限。
3. Python 版本：推荐 Python 3.8 及以上（需与依赖库版本兼容）。

## 四、主要实现功能

### （一）车厢自动计数与分类

1. 支持两种输入方式：静态图像（单帧画面中的列车车厢计数）、动态视频（实时或离线视频流中的车厢连续计数）。
2. 计数精度高：通过目标检测与跟踪的结合，有效避免重复计数、漏计数，适配不同速度、不同类型的列车。

### （二）跨场景适配性

通过多样的测试素材（`video_examples` 模块）验证，项目能够适应不同光照、天气、拍摄角度下的列车场景，具备一定的鲁棒性。

### （三）便捷的使用方式

提供 `run.bat` 一键运行脚本，用户无需手动配置复杂命令，下载项目后安装依赖即可快速启动测试，查看计数效果。

### （四）模块化可扩展

项目采用模块化设计，各功能模块独立解耦，支持后续扩展：

1. 可替换 `models` 模块中的检测模型，提升特定场景下的识别精度。
2. 可优化 `tracker` 模块的跟踪算法，适配更复杂的运动场景（如列车变道、交汇等）。
3. 可扩展输入输出方式，支持更多格式的视频/图像输入，或对接数据库、可视化平台输出计数结果。
